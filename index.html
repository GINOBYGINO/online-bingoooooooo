<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Bingo v0.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #121212; --primary: #00ff41; --secondary: #ff00ff;
            --accent: #ffff00; --error: #ff3333; --text: #eee; 
            --panel: #1e1e1e; --border: #444;
        }
        * { box-sizing: border-box; }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Press Start 2P', cursive;
            margin: 0; overflow: hidden; font-size: 10px;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .screen {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 100; padding: 15px; text-align: center;
        }
        .hidden { display: none !important; }
        
        /* --- UI Components --- */
        .btn {
            background: #000; border: 2px solid #fff; color: #fff;
            padding: 15px 20px; margin: 8px; cursor: pointer; 
            font-family: inherit; font-size: 10px; text-transform: uppercase;
            box-shadow: 4px 4px 0px #333; transition: transform 0.1s;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #333; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; border-color: #666; color: #888; }
        .btn.primary { border-color: var(--primary); color: var(--primary); }

        input {
            background: #000; border: 2px solid #666; color: #fff;
            padding: 10px; font-family: inherit; text-align: center; margin: 5px;
            outline: none; font-size: 12px;
        }
        input:focus { border-color: var(--secondary); }

        /* --- Layout Boxes --- */
        .box {
            background: var(--panel); border: 2px solid var(--border);
            padding: 15px; margin: 10px 0; width: 100%; max-width: 400px;
        }
        .label { font-size: 8px; color: #888; display: block; margin-bottom: 5px; }

        /* --- Bingo Grid --- */
        .bingo-container {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 6px; margin: 15px auto; max-width: 400px; width: 100%;
        }
        .cell {
            aspect-ratio: 1/1; background: #000; border: 2px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; position: relative; transition: all 0.1s; cursor: pointer;
            color: #666;
        }
        
        /* Setup Phase States */
        .cell input { 
            width: 100%; height: 100%; border: none; padding: 0; margin: 0; 
            background: transparent; font-size: 14px; color: var(--primary);
        }
        .cell.error { background: rgba(255, 0, 0, 0.2); border-color: var(--error); }
        .cell.error input { color: var(--error); }

        /* Game Phase States */
        .cell.game-cell { color: #fff; font-size: 16px; }
        .cell.selected { border-color: var(--accent); background: #222; transform: scale(0.95); }
        .cell.marked { 
            background: var(--primary); color: #000; border-color: var(--primary);
            animation: pop 0.2s ease-out;
        }
        .cell.bingo-line {
            background: var(--secondary); color: #fff; border-color: #fff;
            box-shadow: 0 0 15px var(--secondary);
        }

        @keyframes pop { 50% { transform: scale(1.1); } }

        /* --- HUD --- */
        #hud-bar {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: 400px; margin-bottom: 10px;
            background: #222; border-bottom: 2px solid #444; padding: 10px;
        }
        .turn-badge { font-size: 10px; color: #888; }
        .turn-badge.active { color: var(--accent); text-shadow: 0 0 5px var(--accent); }
        .lines-badge { color: var(--secondary); }

        #call-history {
            width: 100%; max-width: 400px; height: 45px;
            overflow-x: auto; display: flex; gap: 8px; align-items: center;
            background: #000; padding: 5px; margin-top: 15px; border: 2px solid #333;
        }
        .ball {
            min-width: 30px; height: 30px; background: #222; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; color: #888; border: 2px solid #444;
        }
        .ball.latest { 
            background: var(--accent); color: #000; border-color: #fff; 
            transform: scale(1.1); font-weight: bold;
        }

        .helper-text { font-size: 8px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1 style="color:var(--primary); font-size:28px; line-height: 1.5; margin-bottom:20px;">
            PIXEL<br><span style="color:#fff">BINGO</span>
            <span style="font-size:10px; color:#666; display:block; margin-top:5px;">v0.3</span>
        </h1>
        
        <input type="text" id="user-name" placeholder="ENTER NAME" maxlength="8" style="width: 200px;">
        
        <div class="box">
            <span class="label">HOST SETTINGS</span>
            <div style="display:flex; justify-content:center; gap:10px;">
                <div><span class="label">MAX NUM</span><input type="number" id="cfg-range" value="25" style="width:60px;"></div>
                <div><span class="label">LINES</span><input type="number" id="cfg-lines" value="3" style="width:40px;"></div>
            </div>
        </div>

        <div>
            <button class="btn" onclick="initGame('local')">SOLO</button>
            <button class="btn primary" onclick="initGame('online')">ONLINE PVP</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen hidden">
        <h2 style="color:var(--secondary)">LOBBY</h2>
        
        <div class="box" onclick="copyId()" style="cursor:pointer; border-style:dashed;">
            <span class="label">ROOM ID (TAP TO COPY)</span>
            <div id="room-id-display" style="color:var(--accent); font-size:12px; margin-top:5px;">CONNECTING...</div>
        </div>

        <div id="join-controls" class="hidden box" style="border-color: var(--primary);">
            <span class="label">JOIN A FRIEND</span>
            <input type="text" id="join-id" placeholder="PASTE ROOM ID" style="width:80%">
            <button class="btn" onclick="joinRoom()">JOIN</button>
        </div>

        <div class="box" style="text-align:left; min-height: 100px;">
            <span class="label">PLAYERS</span>
            <div id="player-list" style="margin-top:10px; line-height:1.8;"></div>
        </div>

        <button class="btn primary" id="host-setup-btn" onclick="hostStartSetup()" disabled>START SETUP</button>
    </div>

    <div id="setup-screen" class="screen hidden">
        <h2 style="color:var(--highlight)">SETUP BOARD</h2>
        <div id="setup-grid" class="bingo-container"></div>
        
        <div style="height:20px; color:var(--error); font-size:9px; margin: 5px 0;" id="setup-msg"></div>

        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="randomizeBoard()">RANDOM</button>
            <button class="btn primary" id="ready-btn" onclick="toggleReady()" disabled>READY</button>
        </div>
        
        <div id="ready-status" style="font-size:9px; margin-top:10px; color:#666;">WAITING...</div>
        <button class="btn hidden" id="host-start-btn" onclick="hostStartGame()" style="margin-top:15px; width: 100%; border-color:var(--accent);">START GAME</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="hud-bar">
            <div id="turn-badge" class="turn-badge">WAITING...</div>
            <div id="lines-badge" class="lines-badge">LINES: 0/3</div>
        </div>

        <p class="helper-text">
            <span style="color:var(--accent)">DOUBLE TAP</span> A NUMBER TO CALL IT
        </p>

        <div id="game-grid" class="bingo-container"></div>
        <div id="call-history"></div>
    </div>

    <div id="victory-screen" class="screen hidden" style="background:rgba(10,10,10,0.95);">
        <h1 style="color:gold; font-size:40px; margin-bottom:10px;">BINGO!</h1>
        <div style="font-size:12px; color:#888;">WINNER</div>
        <h2 id="winner-text" style="color:var(--primary); margin: 20px 0; font-size: 24px;">-</h2>
        <button class="btn" onclick="location.reload()">MAIN MENU</button>
    </div>

    <script>
        // --- Global State ---
        let mode = 'local';
        let isHost = false;
        let myName = "";
        let players = []; 
        let myIdx = -1;
        let config = { range: 25, lines: 3 };
        
        let myBoard = Array(25).fill(0);
        let marked = Array(25).fill(false);
        let calledNums = [];
        let curTurn = 0;
        let selectedCell = -1; // 用於雙擊判斷

        // --- P2P ---
        let peer = null;
        let conns = [];

        // --- Init ---
        function initGame(m) {
            mode = m;
            myName = document.getElementById('user-name').value.trim() || "PLAYER";
            config.range = parseInt(document.getElementById('cfg-range').value) || 25;
            config.lines = parseInt(document.getElementById('cfg-lines').value) || 3;
            
            document.getElementById('start-screen').classList.add('hidden');
            
            if (mode === 'local') {
                isHost = true;
                players = [{id:'local', name:myName, ready:false}];
                hostStartSetup();
            } else {
                document.getElementById('lobby-screen').classList.remove('hidden');
                initPeer();
            }
        }

        function initPeer() {
            peer = new Peer();
            peer.on('open', id => {
                isHost = true; myIdx = 0;
                document.getElementById('room-id-display').innerText = id;
                players = [{id:id, name:myName, ready:false}];
                updateLobby();
            });
            peer.on('connection', conn => {
                conns.push(conn);
                conn.on('open', () => conn.send({type:'SYNC_CFG', config}));
                conn.on('data', data => handleData(data, conn));
            });
            if(!isHost) document.getElementById('join-controls').classList.remove('hidden'); 
        }

        function joinRoom() {
            const hostId = document.getElementById('join-id').value.trim();
            if(!hostId) return;
            if(peer) peer.destroy();
            
            peer = new Peer();
            peer.on('open', id => {
                isHost = false;
                const conn = peer.connect(hostId);
                conns = [conn];
                conn.on('open', () => conn.send({type:'JOIN', name:myName}));
                conn.on('data', data => handleData(data, conn));
                document.getElementById('room-id-display').innerText = "JOINING...";
                document.getElementById('join-controls').classList.add('hidden');
            });
        }

        function handleData(data, conn) {
            // Host Logic
            if(isHost) {
                if(data.type === 'JOIN') {
                    players.push({id:conn.peer, name:data.name, ready:false});
                    updateLobby();
                    broadcast({type:'SYNC_PLAYERS', players});
                }
                if(data.type === 'READY_TOGGLE') {
                    const p = players.find(x => x.id === conn.peer);
                    if(p) p.ready = data.val;
                    broadcast({type:'SYNC_PLAYERS', players});
                    checkReadyStatus();
                }
                if(data.type === 'REQUEST_CALL') {
                    // (3) 同步核心：Host 收到請求 -> 驗證 -> 廣播
                    processCall(data.num); 
                }
                if(data.type === 'WINNER') {
                    broadcast(data); // Relay winner
                    showVictory(data.name);
                }
            }
            
            // Client Logic (Everyone receives these)
            if(data.type === 'SYNC_PLAYERS') {
                players = data.players;
                myIdx = players.findIndex(p => p.id === peer.id);
                updateLobby();
                checkReadyStatus();
            }
            if(data.type === 'SYNC_CFG') config = data.config;
            if(data.type === 'START_SETUP') startSetupPhase();
            if(data.type === 'START_GAME') startGamePhase();
            if(data.type === 'CALL_UPDATE') applyCall(data.num, data.nextTurn);
            if(data.type === 'WINNER') showVictory(data.name);
        }

        function broadcast(msg) { conns.forEach(c => c.send(msg)); }

        // --- Lobby ---
        function updateLobby() {
            const list = document.getElementById('player-list');
            list.innerHTML = players.map(p => 
                `<div><span style="color:${p.ready?'var(--primary)':'#666'}">●</span> ${p.name}</div>`
            ).join('');
            if(isHost) document.getElementById('host-setup-btn').disabled = false;
        }

        function hostStartSetup() {
            if(isHost) { broadcast({type:'START_SETUP'}); startSetupPhase(); }
        }

        // --- Setup ---
        function startSetupPhase() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.remove('hidden');
            renderSetupGrid();
        }

        function renderSetupGrid() {
            const grid = document.getElementById('setup-grid');
            grid.innerHTML = '';
            for(let i=0; i<25; i++) {
                let div = document.createElement('div');
                div.className = 'cell';
                let inp = document.createElement('input');
                inp.type = "number";
                inp.value = myBoard[i] || '';
                // 即時驗證
                inp.oninput = (e) => { myBoard[i] = parseInt(e.target.value); validateBoard(); };
                div.appendChild(inp);
                grid.appendChild(div);
            }
        }

        // (2) 輸入驗證：重複或非法數字
        function validateBoard() {
            const cells = document.getElementById('setup-grid').children;
            const counts = {};
            let hasError = false;
            let errorMsg = "";

            myBoard.forEach(n => { if(n) counts[n] = (counts[n]||0)+1; });

            for(let i=0; i<25; i++) {
                const val = myBoard[i];
                const cell = cells[i];
                cell.classList.remove('error');
                
                if(isNaN(val) || val < 1 || val > config.range) {
                    if(val !== 0 && !isNaN(val)) { cell.classList.add('error'); hasError = true; errorMsg = "OUT OF RANGE"; }
                } else if(counts[val] > 1) {
                    cell.classList.add('error'); hasError = true; errorMsg = "DUPLICATE NUMBERS";
                }
            }

            const isFull = myBoard.filter(n => n > 0).length === 25;
            const btn = document.getElementById('ready-btn');
            const msgEl = document.getElementById('setup-msg');

            if(hasError) {
                btn.disabled = true;
                msgEl.innerText = errorMsg;
            } else if(!isFull) {
                btn.disabled = true;
                msgEl.innerText = "FILL ALL CELLS";
            } else {
                btn.disabled = false;
                msgEl.innerText = "";
            }
        }

        function randomizeBoard() {
            let pool = Array.from({length: config.range}, (_, i) => i + 1);
            for(let i=pool.length-1; i>0; i--){
                const j = Math.floor(Math.random()*(i+1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            myBoard = pool.slice(0, 25);
            renderSetupGrid();
            validateBoard();
        }

        function toggleReady() {
            const me = players[myIdx];
            const newVal = !me.ready;
            
            if(isHost) {
                me.ready = newVal;
                checkReadyStatus();
                broadcast({type:'SYNC_PLAYERS', players});
            } else {
                conns[0].send({type:'READY_TOGGLE', val: newVal});
                document.getElementById('ready-btn').innerText = newVal ? "WAIT..." : "READY";
            }
        }

        function checkReadyStatus() {
            const readyCount = players.filter(p => p.ready).length;
            document.getElementById('ready-status').innerText = `READY: ${readyCount}/${players.length}`;
            
            const me = players[myIdx];
            if(me) document.getElementById('ready-btn').innerText = me.ready ? "WAITING..." : "READY";
            document.getElementById('ready-btn').classList.toggle('primary', !me.ready);

            if(isHost) {
                const allReady = readyCount === players.length && players.length > 0;
                const startBtn = document.getElementById('host-start-btn');
                startBtn.classList.toggle('hidden', !allReady);
            }
        }

        function hostStartGame() {
            broadcast({type:'START_GAME'});
            startGamePhase();
        }

        // --- Game Phase ---
        function startGamePhase() {
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            renderGameGrid();
            updateTurnUI();
        }

        function renderGameGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';
            myBoard.forEach((num, idx) => {
                let div = document.createElement('div');
                div.className = 'cell game-cell';
                div.id = `gcell-${idx}`;
                div.innerText = num;
                // (1) 綁定雙擊事件
                div.onclick = () => handleCellClick(idx, num);
                grid.appendChild(div);
            });
        }

        // (1) 雙擊叫號邏輯
        function handleCellClick(idx, num) {
            // 規則：必須是你的回合，且該數字未被選過
            if(curTurn !== myIdx) return;
            if(marked[idx] || calledNums.includes(num)) return;

            if(selectedCell === idx) {
                // 第二次點擊：確認叫號
                if(isHost) processCall(num);
                else conns[0].send({type:'REQUEST_CALL', num: num});
                
                selectedCell = -1; // 重置
                updateSelection();
            } else {
                // 第一次點擊：選中
                selectedCell = idx;
                updateSelection();
            }
        }

        function updateSelection() {
            for(let i=0; i<25; i++) {
                const cell = document.getElementById(`gcell-${i}`);
                if(i === selectedCell) cell.classList.add('selected');
                else cell.classList.remove('selected');
            }
        }

        // (3) 核心同步：只有 Host 決定下一回合與廣播
        function processCall(num) {
            if(calledNums.includes(num)) return; // 防重複
            
            const nextTurn = (curTurn + 1) % players.length;
            
            // Host 更新自己
            applyCall(num, nextTurn);
            // Host 廣播給所有人
            broadcast({type:'CALL_UPDATE', num: num, nextTurn: nextTurn});
        }

        function applyCall(num, nextTurn) {
            calledNums.unshift(num);
            curTurn = nextTurn;
            
            // 如果我的版面上有這個數字，標記它
            const idx = myBoard.indexOf(num);
            if(idx !== -1) {
                marked[idx] = true;
                const cell = document.getElementById(`gcell-${idx}`);
                if(cell) {
                    cell.classList.add('marked');
                    cell.classList.remove('selected');
                }
            }

            updateHistoryUI();
            updateTurnUI();
            checkWin();
        }

        function updateHistoryUI() {
            const container = document.getElementById('call-history');
            container.innerHTML = calledNums.map((n, i) => 
                `<div class="ball ${i===0?'latest':''}">${n}</div>`
            ).join('');
        }

        function updateTurnUI() {
            const badge = document.getElementById('turn-badge');
            const isMe = (curTurn === myIdx);
            
            if(isMe) {
                badge.innerText = "YOUR TURN";
                badge.className = "turn-badge active";
            } else {
                badge.innerText = `${players[curTurn].name}'S TURN`;
                badge.className = "turn-badge";
            }
        }

        function checkWin() {
            let lines = 0;
            // Rows & Cols
            for(let i=0; i<5; i++) {
                if(marked.slice(i*5, i*5+5).every(x=>x)) lines++; // Row
                if([0,1,2,3,4].map(r => marked[r*5+i]).every(x=>x)) lines++; // Col
            }
            // Diagonals
            if([0,6,12,18,24].map(i=>marked[i]).every(x=>x)) lines++;
            if([4,8,12,16,20].map(i=>marked[i]).every(x=>x)) lines++;

            // Highlight Winning Lines
            // (為了保持代碼簡潔，這裡只做計數，若需要精確高亮線條可加回 winningCells 邏輯)
            
            document.getElementById('lines-badge').innerText = `LINES: ${lines}/${config.lines}`;

            if(lines >= config.lines) {
                const msg = {type:'WINNER', name:myName};
                if(isHost) { broadcast(msg); showVictory(myName); }
                else conns[0].send(msg);
            }
        }

        function showVictory(name) {
            document.getElementById('victory-screen').classList.remove('hidden');
            document.getElementById('winner-text').innerText = name;
        }

        function copyId() {
            navigator.clipboard.writeText(document.getElementById('room-id-display').innerText);
            alert("ROOM ID COPIED!");
        }
    </script>
</body>
</html>
