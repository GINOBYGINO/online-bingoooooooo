<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Bingo v0.4</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #121212; --primary: #00ff41; --secondary: #ff00ff;
            --accent: #ffff00; --error: #ff3333; --text: #eee; 
            --panel: #1e1e1e; --border: #444;
        }
        * { box-sizing: border-box; }
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Press Start 2P', cursive;
            margin: 0; overflow: hidden; font-size: 10px;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .screen {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 100; padding: 15px; text-align: center;
        }
        .hidden { display: none !important; }
        
        /* --- UI Components --- */
        .btn {
            background: #000; border: 2px solid #fff; color: #fff;
            padding: 15px 20px; margin: 8px; cursor: pointer; 
            font-family: inherit; font-size: 10px; text-transform: uppercase;
            box-shadow: 4px 4px 0px #333; transition: transform 0.1s;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px #333; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; border-color: #666; color: #888; }
        .btn.primary { border-color: var(--primary); color: var(--primary); }

        input {
            background: #000; border: 2px solid #666; color: #fff;
            padding: 10px; font-family: inherit; text-align: center; margin: 5px;
            outline: none; font-size: 12px;
        }
        input:focus { border-color: var(--secondary); }

        /* --- Layout Boxes --- */
        .box {
            background: var(--panel); border: 2px solid var(--border);
            padding: 15px; margin: 10px 0; width: 100%; max-width: 400px;
        }
        .label { font-size: 8px; color: #888; display: block; margin-bottom: 5px; }

        /* --- Bingo Grid --- */
        .bingo-container {
            display: grid; grid-template-columns: repeat(5, 1fr);
            gap: 6px; margin: 15px auto; max-width: 400px; width: 100%;
        }
        .cell {
            aspect-ratio: 1/1; background: #000; border: 2px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; position: relative; transition: all 0.1s; cursor: pointer;
            color: #666;
        }
        
        /* Setup Phase States */
        .cell input { 
            width: 100%; height: 100%; border: none; padding: 0; margin: 0; 
            background: transparent; font-size: 14px; color: var(--primary);
        }
        .cell.error { background: rgba(255, 0, 0, 0.2); border-color: var(--error); }
        .cell.error input { color: var(--error); }

        /* Game Phase States */
        .cell.game-cell { color: #fff; font-size: 16px; }
        .cell.selected { border-color: var(--accent); background: #222; transform: scale(0.95); }
        .cell.marked { 
            background: var(--primary); color: #000; border-color: var(--primary);
            animation: pop 0.2s ease-out;
        }
        .cell.bingo-line {
            background: var(--secondary); color: #fff; border-color: #fff;
            box-shadow: 0 0 15px var(--secondary);
        }

        @keyframes pop { 50% { transform: scale(1.1); } }

        /* --- HUD --- */
        #hud-bar {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: 400px; margin-bottom: 10px;
            background: #222; border-bottom: 2px solid #444; padding: 10px;
        }
        .turn-badge { font-size: 10px; color: #888; }
        .turn-badge.active { color: var(--accent); text-shadow: 0 0 5px var(--accent); }
        .lines-badge { color: var(--secondary); }

        #call-history {
            width: 100%; max-width: 400px; height: 45px;
            overflow-x: auto; display: flex; gap: 8px; align-items: center;
            background: #000; padding: 5px; margin-top: 15px; border: 2px solid #333;
        }
        .ball {
            min-width: 30px; height: 30px; background: #222; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; 
            font-size: 10px; color: #888; border: 2px solid #444;
        }
        .ball.latest { 
            background: var(--accent); color: #000; border-color: #fff; 
            transform: scale(1.1); font-weight: bold;
        }

        .helper-text { font-size: 8px; color: #666; margin-top: 5px; }
        
        /* Bingo 按鈕 */
        #bingo-btn {
            margin-top: 15px; border-color: gold; color: gold;
            width: 100%; max-width: 400px; animation: pulse 2s infinite;
            display: none; /* 初始隱藏，達到條件時才顯示 */
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        
        /* 提示訊息 */
        .bingo-alert {
            color: gold;
            font-size: 9px;
            margin-top: 5px;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* 數字輸入框調整 */
        .config-inputs {
            display: flex; justify-content: center; gap: 15px; margin-top: 10px;
        }
        .config-group {
            display: flex; flex-direction: column; align-items: center;
        }
        .config-group input {
            width: 80px; padding: 10px; font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="start-screen" class="screen">
        <h1 style="color:var(--primary); font-size:28px; line-height: 1.5; margin-bottom:20px;">
            PIXEL<br><span style="color:#fff">BINGO</span>
            <span style="font-size:10px; color:#666; display:block; margin-top:5px;">v0.4</span>
        </h1>
        
        <input type="text" id="user-name" placeholder="ENTER NAME" maxlength="8" style="width: 200px;">
        
        <div class="box">
            <span class="label">HOST SETTINGS</span>
            <div class="config-inputs">
                <div class="config-group">
                    <span class="label">MAX NUM</span>
                    <input type="number" id="cfg-range" value="25" min="15" max="100" step="5">
                </div>
                <div class="config-group">
                    <span class="label">LINES</span>
                    <input type="number" id="cfg-lines" value="3" min="1" max="10">
                </div>
            </div>
        </div>

        <div>
            <button class="btn" onclick="initGame('local')">SOLO</button>
            <button class="btn primary" onclick="initGame('online')">ONLINE PVP</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen hidden">
        <h2 style="color:var(--secondary)">LOBBY</h2>
        
        <div class="box" onclick="copyId()" style="cursor:pointer; border-style:dashed;">
            <span class="label">ROOM ID (TAP TO COPY)</span>
            <div id="room-id-display" style="color:var(--accent); font-size:12px; margin-top:5px;">CONNECTING...</div>
        </div>

        <div id="join-controls" class="hidden box" style="border-color: var(--primary);">
            <span class="label">JOIN A FRIEND</span>
            <input type="text" id="join-id" placeholder="PASTE ROOM ID" style="width:80%">
            <button class="btn" onclick="joinRoom()">JOIN</button>
        </div>

        <div class="box" style="text-align:left; min-height: 100px;">
            <span class="label">PLAYERS</span>
            <div id="player-list" style="margin-top:10px; line-height:1.8;"></div>
        </div>

        <button class="btn primary" id="host-setup-btn" onclick="hostStartSetup()" disabled>START SETUP</button>
    </div>

    <div id="setup-screen" class="screen hidden">
        <h2 style="color:var(--highlight)">SETUP BOARD</h2>
        <div id="setup-grid" class="bingo-container"></div>
        
        <div style="height:20px; color:var(--error); font-size:9px; margin: 5px 0;" id="setup-msg"></div>

        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="randomizeBoard()">RANDOM</button>
            <button class="btn primary" id="ready-btn" onclick="toggleReady()" disabled>READY</button>
        </div>
        
        <div id="ready-status" style="font-size:9px; margin-top:10px; color:#666;">WAITING...</div>
        <button class="btn hidden" id="host-start-btn" onclick="hostStartGame()" style="margin-top:15px; width: 100%; border-color:var(--accent);">START GAME</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="hud-bar">
            <div id="turn-badge" class="turn-badge">WAITING...</div>
            <div id="lines-badge" class="lines-badge">LINES: 0/3</div>
        </div>

        <p class="helper-text">
            <span style="color:var(--accent)">DOUBLE TAP</span> A NUMBER TO CALL IT
        </p>

        <div id="game-grid" class="bingo-container"></div>
        
        <div id="bingo-alert" class="bingo-alert" style="display:none;">BINGO READY! PRESS BUTTON</div>
        <button class="btn" id="bingo-btn" onclick="declareBingo()">BINGO!</button>
        
        <div id="call-history"></div>
    </div>

    <div id="victory-screen" class="screen hidden" style="background:rgba(10,10,10,0.95);">
        <h1 style="color:gold; font-size:40px; margin-bottom:10px;">BINGO!</h1>
        <div style="font-size:12px; color:#888;">WINNER</div>
        <h2 id="winner-text" style="color:var(--primary); margin: 20px 0; font-size: 24px;">-</h2>
        <button class="btn" onclick="location.reload()">MAIN MENU</button>
        <button class="btn" onclick="rematch()" style="margin-top:10px; border-color: var(--primary);">PLAY AGAIN</button>
    </div>

    <script>
        // --- Global State ---
        let mode = 'local';
        let isHost = false;
        let myName = "";
        let players = []; 
        let myIdx = -1;
        let config = { range: 25, lines: 3 };
        
        let myBoard = Array(25).fill(0);
        let marked = Array(25).fill(false);
        let calledNums = [];
        let curTurn = 0;
        let selectedCell = -1;
        let lastClickTime = 0;
        let lastClickIdx = -1;
        let winningCells = [];
        let canDeclareBingo = false; // 是否可以宣告Bingo

        // --- P2P ---
        let peer = null;
        let conns = [];

        // --- Init ---
        function initGame(m) {
            mode = m;
            myName = document.getElementById('user-name').value.trim() || "PLAYER";
            config.range = parseInt(document.getElementById('cfg-range').value) || 25;
            config.lines = parseInt(document.getElementById('cfg-lines').value) || 3;
            
            document.getElementById('start-screen').classList.add('hidden');
            
            if (mode === 'local') {
                // 修正1: 單人模式直接進入設定
                isHost = true;
                players = [{id:'local', name:myName, ready:true}];
                myIdx = 0;
                startSetupPhase();
            } else {
                document.getElementById('lobby-screen').classList.remove('hidden');
                initPeer();
            }
        }

        function initPeer() {
            peer = new Peer();
            peer.on('open', id => {
                isHost = true; myIdx = 0;
                document.getElementById('room-id-display').innerText = id;
                players = [{id:id, name:myName, ready:false}];
                updateLobby();
            });
            peer.on('connection', conn => {
                conns.push(conn);
                conn.on('open', () => conn.send({type:'SYNC_CFG', config}));
                conn.on('data', data => handleData(data, conn));
            });
            if(!isHost) document.getElementById('join-controls').classList.remove('hidden'); 
        }

        function joinRoom() {
            const hostId = document.getElementById('join-id').value.trim();
            if(!hostId) return;
            if(peer) peer.destroy();
            
            peer = new Peer();
            peer.on('open', id => {
                isHost = false;
                const conn = peer.connect(hostId);
                conns = [conn];
                conn.on('open', () => conn.send({type:'JOIN', name:myName}));
                conn.on('data', data => handleData(data, conn));
                document.getElementById('room-id-display').innerText = "JOINING...";
                document.getElementById('join-controls').classList.add('hidden');
            });
        }

        function handleData(data, conn) {
            // Host Logic
            if(isHost) {
                if(data.type === 'JOIN') {
                    players.push({id:conn.peer, name:data.name, ready:false});
                    updateLobby();
                    broadcast({type:'SYNC_PLAYERS', players});
                }
                if(data.type === 'READY_TOGGLE') {
                    const p = players.find(x => x.id === conn.peer);
                    if(p) p.ready = data.val;
                    broadcast({type:'SYNC_PLAYERS', players});
                    checkReadyStatus();
                }
                if(data.type === 'REQUEST_CALL') {
                    processCall(data.num); 
                }
                if(data.type === 'WINNER') {
                    broadcast(data); // Relay winner
                    showVictory(data.name);
                }
                if(data.type === 'BINGO_DECLARE') {
                    // 驗證Bingo
                    broadcast({type:'WINNER', name:data.name});
                    showVictory(data.name);
                }
                if(data.type === 'REMATCH_REQUEST') {
                    handleRematch();
                }
            }
            
            // Client Logic (Everyone receives these)
            if(data.type === 'SYNC_PLAYERS') {
                players = data.players;
                myIdx = players.findIndex(p => p.id === peer.id);
                updateLobby();
                checkReadyStatus();
            }
            if(data.type === 'SYNC_CFG') config = data.config;
            if(data.type === 'START_SETUP') startSetupPhase();
            if(data.type === 'START_GAME') startGamePhase();
            if(data.type === 'CALL_UPDATE') applyCall(data.num, data.nextTurn);
            if(data.type === 'WINNER') showVictory(data.name);
        }

        function broadcast(msg) { 
            if(mode !== 'local') {
                conns.forEach(c => {
                    try {
                        c.send(msg);
                    } catch(e) {
                        console.log("Send failed:", e);
                    }
                });
            }
        }

        // --- Lobby ---
        function updateLobby() {
            const list = document.getElementById('player-list');
            list.innerHTML = players.map(p => 
                `<div><span style="color:${p.ready?'var(--primary)':'#666'}">●</span> ${p.name}</div>`
            ).join('');
            if(isHost) document.getElementById('host-setup-btn').disabled = false;
        }

        function hostStartSetup() {
            if(isHost) { 
                broadcast({type:'START_SETUP'}); 
                startSetupPhase(); 
            }
        }

        // --- Setup ---
        function startSetupPhase() {
            // 隱藏其他畫面
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('setup-screen').classList.remove('hidden');
            
            renderSetupGrid();
            
            // 單人模式特殊處理
            if(mode === 'local') {
                document.getElementById('ready-btn').classList.add('hidden');
                document.getElementById('host-start-btn').classList.remove('hidden');
                document.getElementById('ready-status').innerText = "SOLO MODE - FILL YOUR BOARD";
            }
        }

        function renderSetupGrid() {
            const grid = document.getElementById('setup-grid');
            grid.innerHTML = '';
            for(let i=0; i<25; i++) {
                let div = document.createElement('div');
                div.className = 'cell';
                let inp = document.createElement('input');
                inp.type = "number";
                inp.value = myBoard[i] || '';
                inp.oninput = (e) => { 
                    myBoard[i] = parseInt(e.target.value) || 0; 
                    validateBoard(); 
                };
                div.appendChild(inp);
                grid.appendChild(div);
            }
            validateBoard();
        }

        function validateBoard() {
            const cells = document.getElementById('setup-grid').children;
            const counts = {};
            let hasError = false;
            let errorMsg = "";

            myBoard.forEach(n => { if(n) counts[n] = (counts[n]||0)+1; });

            for(let i=0; i<25; i++) {
                const val = myBoard[i];
                const cell = cells[i];
                cell.classList.remove('error');
                
                if(val < 1 || val > config.range) {
                    if(val !== 0) { 
                        cell.classList.add('error'); 
                        hasError = true; 
                        errorMsg = "OUT OF RANGE 1-" + config.range; 
                    }
                } else if(counts[val] > 1) {
                    cell.classList.add('error'); 
                    hasError = true; 
                    errorMsg = "DUPLICATE NUMBERS";
                }
            }

            const isFull = myBoard.filter(n => n > 0).length === 25;
            const btn = document.getElementById('ready-btn');
            const msgEl = document.getElementById('setup-msg');

            if(hasError) {
                btn.disabled = true;
                msgEl.innerText = errorMsg;
            } else if(!isFull) {
                btn.disabled = true;
                msgEl.innerText = "FILL ALL CELLS";
            } else {
                btn.disabled = false;
                msgEl.innerText = "";
            }
            
            // 單人模式直接啟用開始按鈕
            if(mode === 'local' && isFull && !hasError) {
                document.getElementById('host-start-btn').disabled = false;
            }
        }

        function randomizeBoard() {
            let pool = Array.from({length: config.range}, (_, i) => i + 1);
            for(let i=pool.length-1; i>0; i--){
                const j = Math.floor(Math.random()*(i+1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            myBoard = pool.slice(0, 25);
            renderSetupGrid();
            validateBoard();
        }

        function toggleReady() {
            const me = players[myIdx];
            const newVal = !me.ready;
            
            if(isHost) {
                me.ready = newVal;
                checkReadyStatus();
                broadcast({type:'SYNC_PLAYERS', players});
            } else {
                conns[0].send({type:'READY_TOGGLE', val: newVal});
                document.getElementById('ready-btn').innerText = newVal ? "WAIT..." : "READY";
            }
        }

        function checkReadyStatus() {
            const readyCount = players.filter(p => p.ready).length;
            document.getElementById('ready-status').innerText = `READY: ${readyCount}/${players.length}`;
            
            const me = players[myIdx];
            if(me) document.getElementById('ready-btn').innerText = me.ready ? "WAITING..." : "READY";
            document.getElementById('ready-btn').classList.toggle('primary', !me.ready);

            if(isHost) {
                const allReady = readyCount === players.length && players.length > 0;
                const startBtn = document.getElementById('host-start-btn');
                startBtn.classList.toggle('hidden', !allReady);
            }
        }

        function hostStartGame() {
            if(mode === 'local') {
                startGamePhase();
            } else {
                broadcast({type:'START_GAME'});
                startGamePhase();
            }
        }

        // --- Game Phase ---
        function startGamePhase() {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('game-screen').classList.remove('hidden');
            
            // 重置遊戲狀態
            marked = Array(25).fill(false);
            calledNums = [];
            curTurn = 0;
            selectedCell = -1;
            winningCells = [];
            canDeclareBingo = false;
            lastClickTime = 0;
            lastClickIdx = -1;
            
            // 隱藏Bingo按鈕和提示
            document.getElementById('bingo-btn').style.display = 'none';
            document.getElementById('bingo-alert').style.display = 'none';
            
            renderGameGrid();
            updateTurnUI();
        }

        function renderGameGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = '';
            myBoard.forEach((num, idx) => {
                let div = document.createElement('div');
                div.className = 'cell game-cell';
                div.id = `gcell-${idx}`;
                div.innerText = num;
                
                // 綁定點擊事件
                div.onclick = () => handleCellClick(idx, num);
                grid.appendChild(div);
            });
            updateCellColors();
        }

        // 修正2: 恢復雙擊效果
        function handleCellClick(idx, num) {
            // 如果已經達成Bingo條件，不能叫號
            if(canDeclareBingo) return;
            
            // 規則：必須是你的回合，且該數字未被選過
            if(mode !== 'local' && curTurn !== myIdx) return;
            if(marked[idx] || calledNums.includes(num)) return;
            
            const now = Date.now();
            
            // 檢查是否為雙擊 (500ms內點擊相同格子)
            if(lastClickIdx === idx && now - lastClickTime < 500) {
                // 雙擊確認叫號
                if(isHost || mode === 'local') {
                    processCall(num);
                } else {
                    conns[0].send({type:'REQUEST_CALL', num: num});
                }
                
                // 重置點擊狀態
                lastClickTime = 0;
                lastClickIdx = -1;
                selectedCell = -1;
                updateSelection();
            } else {
                // 第一次點擊：選中候選格
                selectedCell = idx;
                lastClickTime = now;
                lastClickIdx = idx;
                updateSelection();
            }
        }

        function updateSelection() {
            for(let i=0; i<25; i++) {
                const cell = document.getElementById(`gcell-${i}`);
                if(cell) {
                    // 選中狀態
                    cell.classList.toggle('selected', i === selectedCell);
                    
                    // 連線狀態和標記狀態
                    if(winningCells.includes(i)) {
                        cell.classList.add('bingo-line');
                    } else if(marked[i]) {
                        cell.classList.add('marked');
                    } else {
                        cell.classList.remove('marked', 'bingo-line');
                    }
                }
            }
        }

        function updateCellColors() {
            for(let i=0; i<25; i++) {
                const cell = document.getElementById(`gcell-${i}`);
                if(cell) {
                    // 清除所有顏色類別
                    cell.classList.remove('marked', 'bingo-line', 'selected');
                    
                    // 應用正確的顏色
                    if(winningCells.includes(i)) {
                        cell.classList.add('bingo-line');
                    } else if(marked[i]) {
                        cell.classList.add('marked');
                    }
                }
            }
        }

        function processCall(num) {
            if(calledNums.includes(num)) return;
            
            const nextTurn = (mode === 'local') ? 0 : (curTurn + 1) % players.length;
            
            // Host 更新自己
            applyCall(num, nextTurn);
            // 如果不是單人模式，廣播給其他人
            if(mode !== 'local') {
                broadcast({type:'CALL_UPDATE', num: num, nextTurn: nextTurn});
            }
        }

        function applyCall(num, nextTurn) {
            calledNums.unshift(num);
            curTurn = nextTurn;
            
            // 如果我的版面上有這個數字，標記它
            const idx = myBoard.indexOf(num);
            if(idx !== -1) {
                marked[idx] = true;
            }

            updateHistoryUI();
            updateTurnUI();
            checkBingoCondition(); // 修正3: 檢查是否達到Bingo條件，但不自動宣告
        }

        function updateHistoryUI() {
            const container = document.getElementById('call-history');
            container.innerHTML = calledNums.map((n, i) => 
                `<div class="ball ${i===0?'latest':''}">${n}</div>`
            ).join('');
        }

        function updateTurnUI() {
            if(mode === 'local') {
                document.getElementById('turn-badge').innerText = "SOLO MODE";
                document.getElementById('turn-badge').className = "turn-badge";
                return;
            }
            
            const badge = document.getElementById('turn-badge');
            const isMe = (curTurn === myIdx);
            
            if(isMe) {
                badge.innerText = "YOUR TURN";
                badge.className = "turn-badge active";
            } else {
                badge.innerText = `${players[curTurn]?.name || 'Unknown'}'S TURN`;
                badge.className = "turn-badge";
            }
        }

        // 修正3: 檢查Bingo條件但不自動宣告
        function checkBingoCondition() {
            winningCells = [];
            let lines = 0;
            
            // 檢查橫行
            for(let i=0; i<5; i++) {
                const rowCells = [i*5, i*5+1, i*5+2, i*5+3, i*5+4];
                if(rowCells.every(idx => marked[idx])) {
                    lines++;
                    winningCells.push(...rowCells);
                }
            }
            // 檢查直列
            for(let i=0; i<5; i++) {
                const colCells = [i, i+5, i+10, i+15, i+20];
                if(colCells.every(idx => marked[idx])) {
                    lines++;
                    winningCells.push(...colCells);
                }
            }
            // 檢查對角線
            const diag1 = [0, 6, 12, 18, 24];
            if(diag1.every(idx => marked[idx])) {
                lines++;
                winningCells.push(...diag1);
            }
            const diag2 = [4, 8, 12, 16, 20];
            if(diag2.every(idx => marked[idx])) {
                lines++;
                winningCells.push(...diag2);
            }

            document.getElementById('lines-badge').innerText = `LINES: ${lines}/${config.lines}`;
            updateCellColors();
            
            // 達到條件但不自動宣告，只顯示提示和按鈕
            if(lines >= config.lines) {
                canDeclareBingo = true;
                document.getElementById('bingo-btn').style.display = 'block';
                document.getElementById('bingo-alert').style.display = 'block';
                return true;
            } else {
                canDeclareBingo = false;
                document.getElementById('bingo-btn').style.display = 'none';
                document.getElementById('bingo-alert').style.display = 'none';
                return false;
            }
        }

        function declareBingo() {
            if(!canDeclareBingo) {
                alert("You don't have enough lines for BINGO yet!");
                return;
            }
            
            const msg = {type:'WINNER', name:myName};
            if(mode === 'local') {
                showVictory(myName);
            } else if(isHost) { 
                broadcast(msg); 
                showVictory(myName); 
            } else {
                conns[0].send({type:'BINGO_DECLARE', name:myName});
            }
        }

        function showVictory(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('victory-screen').classList.remove('hidden');
            document.getElementById('winner-text').innerText = name;
        }

        // 修正4: 修正再玩一次的按鈕
        function rematch() {
            if(mode === 'local') {
                // 單人模式：直接重新開始設置
                myBoard = Array(25).fill(0);
                marked = Array(25).fill(false);
                calledNums = [];
                curTurn = 0;
                winningCells = [];
                canDeclareBingo = false;
                selectedCell = -1;
                
                document.getElementById('victory-screen').classList.add('hidden');
                startSetupPhase();
            } else {
                // 多人模式：發送重賽請求
                if(isHost) {
                    // 房主發起重賽
                    handleRematch();
                    broadcast({type:'REMATCH_REQUEST'});
                } else {
                    // 非房主發送請求
                    conns[0].send({type:'REMATCH_REQUEST'});
                    alert("Rematch request sent to host");
                }
            }
        }

        function handleRematch() {
            // 重置所有玩家的ready狀態
            players.forEach(p => p.ready = false);
            
            // 重置遊戲狀態
            myBoard = Array(25).fill(0);
            marked = Array(25).fill(false);
            calledNums = [];
            curTurn = 0;
            winningCells = [];
            canDeclareBingo = false;
            selectedCell = -1;
            
            // 更新界面
            if(mode !== 'local') {
                document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
                document.getElementById('lobby-screen').classList.remove('hidden');
                updateLobby();
            }
        }

        function copyId() {
            const idText = document.getElementById('room-id-display').innerText;
            if(navigator.clipboard) {
                navigator.clipboard.writeText(idText).then(() => {
                    alert("ROOM ID COPIED!");
                });
            } else {
                // 備用方案
                const textArea = document.createElement('textarea');
                textArea.value = idText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert("ROOM ID COPIED!");
            }
        }
    </script>
</body>
</html>
